Module 9 - Activity 9 - Working with AWS CloudTrail



vpc flowlogs - debug and troubleshoot
cloud watch - monitor infra, app, gather logs and metrics, make infra reactive
cloud trial - audit about api calls, events occured, changes made are monitored



ec2>
Cafe Web Server>
copy public ip>


---browser
<ip>/mompopcafe


security grp.
webserversg>
edit inbound rule>
add rule.
ssh>
ip>
my ip>
save>




cloudtrial>
trials>
crate trial>
Trial name>
Monitor             //give same name
Trail log bucket and folder>
monitoring1234
AWS KMS alias>
monitoring1234
next>
next>
create a trial>


?????????????????????????????????????????????????


log in to instance


$ aws s3 ls
$ mkdir monitorlogs
$ cd monitorlogs/
$ aws s3 cp s3://megharaj0/ . --recursive
	download: s3://megharaj0/AWSLogs/124498311990/CloudTrail/us-east-1/2025/02/12/124498311990_CloudTrail_us-east-1_20250212T0410Z_Ue5VQcM4J6U8xk8n.json.gz to 	AWSLogs/124498311990/CloudTrail/us-east-1/2025/02/12/124498311990_CloudTrail_us-east-1_20250212T0410Z_Ue5VQcM4J6U8xk8n.json.gz
$ ls
$ cd AWSLogs/
$ ls
$ cd 124498311990/
$ ls
$ cd CloudTrail/
$ ls
$ cd us-east-1/
$ ls
$ cd 2025/02/12/
$ ls
	124498311990_CloudTrail_us-east-1_20250212T0410Z_Ue5VQcM4J6U8xk8n.json.gz
$ gunzip *.gz
$ ls
$ cat <filename.json> | python -m json.tool
$ for i in $(ls); do echo $i && cat $i | python -m json.tool | grep sourceIPAddress ; done
$ for i in $(ls); do echo $i && cat $i | python -m json.tool | grep eventName ; done
$ aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=ConsoleLogin
$ aws cloudtrail lookup-events --lookup-attributes AttributeKey=ResourceType,AttributeValue=AWS::EC2::SecurityGroup --output text
$ region=$(curl http://169.254.169.254/latest/dynamic/instance-identity/document|grep region | cut -d '"' -f4)
$ sgId=$(aws ec2 describe-instances --filters "Name=tag:Name,Values='Cafe Web Server'" --query 'Reservations[*].Instances[*].SecurityGroups[*].[GroupId]' --region $region --output text)
$ echo $sgId
$ aws cloudtrail lookup-events --lookup-attributes AttributeKey=ResourceType,AttributeValue=AWS::EC2::SecurityGroup --region $region --output text | grep $sgId



cloudtrial>
monitor>
3 dots>
event history>
Lookup attributes>
event name>
AuthorizeSecurityGroupIngress>

event history>
create athena table>
storage location.
select s3>
create>



athena>
query editor>
settings>
manage>
browse s3>
select bucket>
ok>
s3://megharaj0/results
save>

editor>

SELECT *
FROM cloudtrail_logs_megharaj0
LIMIT 5

run>

SELECT useridentity.userName, eventtime, eventsource, eventname, requestparameters
FROM cloudtrail_logs_megharaj0
LIMIT 30

run>




--terminal
$ sudo adduser msis
$ sudo useradd cdc
$ cat /etc/passwd
$ sudo cat /etc/shadow
					shadow, gshadow
$ who
$ sudo userdel -r chaos-user




ami>
users>
select chaos>
delete>
//cannot delete directly, for that we need to delete login profile from ec2 isntance



--terminal
$ aws iam delete-login-profile --user-name=chaos
$ sudo nano /etc/ssh/sshd_config

#PasswordAuthentication yes
#PermitEmptyPasswords no
PasswordAuthentication no

   44  sudo systemctl restart sshd
   45  cd /var/www/html/
   46  l
   47  ls
   48  cd mompopcafe/
   49  ls
   50  cd images/
   51  ls
   52  sudo mv Coffee.png 
   53  sudo mv Coffee-and-Pastries.backup Coffee-and-Pastries.png
   54  sudo systemctl restart httpd
   55  history

